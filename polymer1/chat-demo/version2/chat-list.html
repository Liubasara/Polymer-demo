<script src="./assets/js/mescroll.min.js"></script>
<link rel="stylesheet" href="./assets/css/mescroll.min.css">

<dom-module id="chat-list">
  <link rel="import" href="./chat-box.html">
  <template>

    <style>
      /* 滚动条相关 */
      :host ::-webkit-scrollbar {
        display: block;
        width: 6px;
        height: 6px;
      }
      :host ::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
        height: 46px;
      }
      :host ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
      }
      :host .chat-list-container {
        height: 100%;
      }
      :host .list-container {
        height: calc(100% - 50px);
        padding: 17.3px 0;
        background: #F5F5F5;
        overflow-y: scroll;
      }
      :host .title-container {
        height: 50px;
        padding: 17px 30px 16px 27px;
        box-shadow: 0px 0px 1px 0px rgba(164,164,164,0.51);
        color: rgba(89,87,87,1);
        font-size: 18px;
        font-weight: bold;
      }
      :host .more-button {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 5px;
        width: 100px;
        height: 25px;
        color: white;
        background-color: gray;
        border-radius: 5px;
        font-size: 12px;
        cursor: pointer;
      }
    </style>

    <div class="chat-list-container">
      <div class="title-container">
        [[title]]
        <template is="dom-if" if="[[title1]]">
          <img src="./assets/imgs/895.png">
          [[title1]]
        </template>
      </div>
      <div class="list-container" id="list-container">
        <template is="dom-if" if="{{showMore}}">
          <div class="more-button" on-click="pullDown">加载更多消息</div>
        </template>
        <template is="dom-repeat" items="[[chatData]]" chunked>
          <chat-box entity="[[item]]" need-analysis="[[needAnalysis]]" />
        </template>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'chat-list',
      properties: {
        title: {
          type: String,
          value: '孙金超'
        },
        title1: {
          type: String,
          value: ''
        },
        chatData: {
          type: Array,
          notify: true
        },
        showMore: {
          type: Boolean,
          value: true
        },
        needAnalysis: {
          type: Boolean,
          value: false
        }
      },
      observers: [
        'observerChatData(chatData.*)'
      ],
      observerChatData (val) {
        /** 滚动相关 **/
        let shouldScroll = false
        let messageConstainer = Polymer.dom(this.root).querySelector('#list-container')
        val.base.forEach(item => item.shouldScroll = shouldScroll)
        if (messageConstainer) {
          let { scrollHeight, clientHeight, scrollTop } = messageConstainer
          shouldScroll = (val.base[val.base.length - 1].id === '0'
                || scrollHeight === clientHeight
                || scrollTop === 0
                || clientHeight * 2 > scrollHeight - scrollTop)
                && (this.showMore || this.showMore === undefined)
          val.base[val.base.length - 1].shouldScroll = shouldScroll
        }
      },
      pullDown (e) {
        this.set('showMore', false)
        const listContainerElem = Polymer.dom(this).node.querySelector('#list-container')
        const downCallback = () => {
          setTimeout(() => {
            // FIXME: Mock Data
            let mockHistoryData = new Array(10).fill(1).map((item, index) => parseInt(Math.random() * (2),10) ? { id: '0', content: `第${index + 1}条历史消息`, name: '刘德华' } : { id: '1', content: `第${index + 1}条历史消息`, name: '梁朝伟' })
            // Set 方式
            let newChatData = mockHistoryData.concat(this.chatData)
            this.set('chatData', newChatData)
            this.async(() => {
              // 滚动至原来滚动条所在地
              // scrollIntoView 不适用于多个进度条存在的情况
              // Polymer.dom(this.root).querySelectorAll('chat-box')[mockHistoryData.length - 1].scrollIntoView()
              listContainerElem.scrollTop = Polymer.dom(this.root).querySelectorAll('chat-box')[mockHistoryData.length - 1].offsetTop - listContainerElem.offsetTop
            }, 0)
            mescroll.endSuccess(mockHistoryData.length)
            this.set('showMore', true)
          }, 1000)
        }
        const mescroll = new MeScroll(listContainerElem, {
          //第一个参数"mescroll"对应上面布局结构div的id
          //如果下拉刷新是重置列表数据,那么down完全可以不用配置
          down: {
            use: true, //是否初始化下拉刷新; 默认true
            auto: true, //是否在初始化完毕之后自动执行下拉回调callback; 默认true
            autoShowLoading: true,
            isLock: true,
            callback: downCallback //下拉刷新的回调
          }
        })
      }
    })
  </script>
</dom-module>