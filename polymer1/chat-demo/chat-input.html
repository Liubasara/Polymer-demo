<dom-module id="chat-input">
  <template>
    <style>
      :host .input-textarea {
        height: 100%;
        width: 100%;
        overflow-y: scroll;
      }
    </style>
    <div
      class="input-textarea"
      id="input-textarea"
      contenteditable="true"
      on-keydown="handleInputKeyDown"
      on-paste="pasteIntoTextArea"
    ></div>
  </template>
  <script>
    Polymer({
      is: 'chat-input',
      properties: {
        chatInputText: {
          type: String,
          value: '',
          notify: true
        },
        chatInputImgs: {
          type: Array,
          value: () => [],
          notify: true
        }
      },
      ready() {
        let inputTextArea = Polymer.dom(this.root).querySelector('#input-textarea')
        inputTextArea.addEventListener('input', this.textAreaChange.bind(this))
      },
      handleInputKeyDown(e) {
        if (e.ctrlKey && e.key === 'Enter') {
          this.chatInputText.trim() &&
            this.fire('send-message', { message: this.chatInputText })
          this.chatInputImgs.forEach(item => {
            this.fire('send-message', { message: item })
          })
        }
      },
      textAreaChange() {
        const textArea = Polymer.dom(this.root).querySelector('#input-textarea')
        let imgLists = textArea.querySelectorAll('img')
        this.set(
          'chatInputImgs',
          [...imgLists].map(item => item.src)
        )
        this.set('chatInputText', textArea.innerText)
      },
      pasteIntoTextArea(e) {
        e.stopPropagation()
        const self = this
        const { items, types } = e.clipboardData || e.originalEvent.clipboardData
        // 如果包含文件内容
        if (types.indexOf('Files') > -1) {
          e.preventDefault()
          for (let index = 0; index < items.length; index++) {
            const item = items[index]
            if (item.kind === 'file') {
              const file = item.getAsFile()
              if (file) {
                const reader = new FileReader()
                const image = new Image()
                reader.onloadend = function handleLoad () {
                  image.src = this.result
                  Polymer.dom(self.root).querySelector('#input-textarea').appendChild(image)
                  /** 触发 textAreaChange **/
                  self.textAreaChange()
                }
                /** 触发 loadend **/
                reader.readAsDataURL(file)
              }
            }
          }
        }
      }
    })
  </script>
</dom-module>
