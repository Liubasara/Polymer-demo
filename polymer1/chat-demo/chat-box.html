<dom-module id="chat-box">
  <template>

    <style>
      :host .img-wrapper {
        height: 24px;
        width: 24px;
      }
      :host .content {
        max-width: 300px;
        cursor: pointer;
      }
      :host .message {
        display: flex;
        width: 100%;
        word-break: break-all;
        margin-bottom: 5px;
      }
      :host .self {
        flex-direction: row-reverse;
      }
    </style>

    <div class$="[[checkMessage(entity.id)]]">
      <div class="img-wrapper"><img src="./avatar0.jpg" alt="头像" height="100%" width="100%" style="border-radius: 22px;"></div>
      <div class="content">[[showTextOrMessage(entity.message)]]</div>
    </div>

  </template>
  <script>
    Polymer({
      is: 'chat-box',
      properties: {
        entity: {
          type: Object,
          notify: true
        }
      },
      attached () {
        if (this.entity.shouldScroll) {
          Polymer.dom(this).node.scrollIntoView()
        }
      },
      showTextOrMessage (message) {
        if (/data:image\//.test(message)) {
          const image = new Image()
          image.src = message
          image.setAttribute('height', '100%')
          image.setAttribute('width', '100%')
          Polymer.dom(this).node.querySelector('.content').appendChild(image)
          return
        }
        return this.formatMessage(message)
      },
      checkMessage (id) {
        switch (id) {
          case '0':
            return 'self message'
            break
          case '1':
            return 'message'
            break
          default:
            return 'message'
            break
        }
      },
      formatMessage (message) {
        /** 格式化 Message **/
        let multiLines = message.split('\n')
        if (multiLines.length > 1) {
          /** 确保每行之间最多只有一个换行符 **/
          multiLines = multiLines.reduce((acc, curr) => {
            if (acc.length === 0) {
              if (curr === '') {
                return acc
              }
              acc.push(curr)
              return acc
            }
            if (acc[acc.length - 1] === '' && curr === '') {
              return acc
            }
            acc.push(curr)
            return acc
          }, [])
          Polymer.dom(this).node.querySelector('.content').innerHTML = multiLines.join('<br>')
          return
        }
        return message
      }
    })
  </script>
</dom-module>